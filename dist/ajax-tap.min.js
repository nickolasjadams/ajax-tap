/**
 * AjaxTap.js
 * 
 * Listen in on any trusted XHR's made on your webpage.
 * Run functions when your conditions are met.
 * 
 * @author Nick Adams
 * @see {@link https://github.com/nickolasjadams/ajax-tap|Repository}
 * @license MIT
 * @version 1.0.3
 */
class AjaxTap{constructor(){this.responseEvents=[],this.dev=!1}addResponseEvent(options){if(!options)throw new Error("Event options are required.");if(!options.conditions)throw new Error("Event conditions are required.");if(!options.fire)throw new Error("Event must have something to fire in response to met conditions.");let responseEvent={trustedMessengers:[],conditions:null,fire:null};return responseEvent.trustedMessengers.push(window.location.origin),options.trustedMessengers&&options.trustedMessengers.forEach(messenger=>{responseEvent.trustedMessengers.push(messenger)}),responseEvent.conditions=options.conditions,responseEvent.fire=options.fire,this.responseEvents.push(responseEvent),this}listen(){if(0==this.responseEvents.length)throw new Error("This tap has no response events to listen to.");try{let _this=this;var origOpen=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(){this.addEventListener("load",function(){let matched=!1,origin=AjaxTap.url(this.responseURL).origin;_this.responseEvents.forEach(e=>{if(!matched&&e.trustedMessengers.some(messenger=>messenger==origin)){var contentType=this.getResponseHeader("content-type");let data;contentType.includes("json")?data=JSON.parse(this.responseText):contentType.includes("html")?data=(new DOMParser).parseFromString(this.responseText,"text/html"):contentType.includes("xml")?data=this.responseXML:contentType.includes("text")&&(data=this.responseText),e.conditions(data)&&(matched=!0,e.fire(data))}})}),origOpen.apply(this,arguments)}}catch(e){dev&&console.error(e)}}static url(str){var a=document.createElement("a");a.setAttribute("href",this);let origin=a.protocol+"//"+a.hostname;var{host,hostname,pathname,port,protocol,search,hash}=a;return{origin:origin=0<a.port.length?origin+":"+a.port:origin,host:host,hostname:hostname,pathname:pathname,port:port,protocol:protocol,search:search,hash:hash}}}